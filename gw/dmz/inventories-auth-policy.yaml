apiVersion: kuadrant.io/v1
kind: AuthPolicy
metadata:
  name: dmz-auth-inventory-policy
  namespace: app-global-dmz
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: inventory-route
    namespace: app-global-dmz
  rules:
    matches:
      - path:
          type: PathPrefix
          value: /
    authentication:
      keycloak:
        jwt:
          issuerUrl: https://auth.arencloud.com:30238/realms/rhcl-demo
          #jwksUrl: https://auth.arencloud.com:30238/realms/rhcl-demo/protocol/openid-connect/certs
          audiences:
            - rhcl-microservices
    authorization:
      opa-role-checks:
        opa:
          rego: |
            package kuadrant.authz
            roles := input.auth.identity.realm_access.roles
            path := input.context.request.http.path
            method := upper(input.context.request.http.method)
            headers := input.context.request.headers
            
            # Safely read header (avoids crash if missing)
            xenv := "" {
              input.context.request.headers["x-env"]
              xenv := lower(input.context.request.headers["x-env"])
            } else {
              xenv := ""
            }
            
            # ---------------------------------------------
            # !!! FIX for "rego_unsafe_var_error" !!!
            # Define the required_header logic as a variable using 'some'
            # to ensure it's bound before use in the response block.
            required_header := true { xenv == "dmz" }
            required_header := false { xenv != "dmz" }
            # ---------------------------------------------
            allow = true
            
            #required_header {
            #  xenv == "dmz"
            #}
            #
            #allow {
            #  required_header
            #  startswith(path, "/api/v1/items")
            #  method == "GET"
            #  roles[_] == "inventory.reader"
            #}
            #allow {
            #  required_header
            #  startswith(path, "/api/v1/items")
            #  method == "POST"
            #  roles[_] == "inventory.writer"
            #}
            #allow {
            #  required_header
            #  startswith(path, "/api/v1/items")
            #  method == "PUT"
            #  roles[_] == "inventory.writer"
            #}
            #allow {
            #  required_header
            #  startswith(path, "/api/v1/items")
            #  method == "DELETE"
            #  roles[_] == "inventory.deleter"
            #}
            
            # -----------------------------
            # DEBUG OUTPUT (Based on the OPA output)
            # -----------------------------
            response := {
              "headers": {
                # 1. Shows the value of the specific header we care about
                "X-Debug-Xenv": xenv, 
            
                # 2. Shows the ENTIRE HEADER MAP (as a JSON string)
                # This will show ALL headers Authorino received from Envoy.
                "X-Debug-All-Headers": json.marshal(headers),

                # 3. Contextual checks
                "X-Debug-Required-Header": required_header,
                "X-Debug-Path": path,
                "X-Debug-Method": method,
              }
            }